{% load static %}
<!DOCTYPE html>
<html lang="en">
{% include "includes/head.html" %}



<body class="hold-transition sidebar-mini layout-fixed">

    <div class="wrapper">
        {%include 'includes/loader.html'%}
        {% include 'includes/topNavbar.html' %}
        {% include 'includes/sideNavbar.html' %}
        <div class="content-wrapper">
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card shadow hidden-transition">
                                <div class="card-body">
                                    <figure class="highcharts-figure">
                                        <div id="splineChart"></div>
                                        <p class="highcharts-description">
                                        </p>
                                    </figure>
                                </div>
                            </div>
                        </div>

                        <!-- dynamic count cards -->
                        <div class="col-lg-4" style="margin: auto;">
                            <div class="card hidden-transition">
                                <div class="card-body">
                                    <div class="d-flex align-items-top ">
                                        <div class="flex-fill">
                                            <h5 class="d-block fw-semibold  mb-1">Total - Survey</h5>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-block ">
                                                    <div class="fw-semibold counter"
                                                        style="font-size: x-large; text-align: center;">
                                                        {{surveys_count}} </div>
                                                    <a href="#" class="nav-link text-primary">
                                                        View All
                                                        <i class="bi bi-arrow-right-circle"></i>
                                                    </a>
                                                </div>
                                                <a class="btn btn-app"
                                                    style="background-color: #0eadfc; border-radius: 10px;">
                                                    <i class=" bi bi-file-earmark-text bi-main"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="card hidden-transition">
                                <div class="card-body">
                                    <div class="d-flex align-items-top ">
                                        <div class="flex-fill">
                                            <h5 class="d-block fw-semibold  mb-1"> Questions </h5>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-block ">
                                                    <div class=" counter"
                                                        style="font-size: x-large; text-align: center;"> {{questions}}
                                                    </div>
                                                    <a href="" class="nav-link" style="color: #5e60ce;">
                                                        View All
                                                        <i class="bi bi-arrow-right-circle"></i>
                                                    </a>
                                                </div>
                                                <a class="btn btn-app"
                                                    style="background-color: #5e60ce; border-radius: 10px;">
                                                    <i class="bi bi-journals bi-main"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="card hidden-transition">
                                <div class="card-body">
                                    <div class="d-flex align-items-top ">
                                        <div class="flex-fill">
                                            <h5 class="d-block fw-semibold  mb-1"> Responses </h5>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-block ">
                                                    <div class=" counter"
                                                        style="font-size: x-large; text-align: center;"> {{Response}}
                                                    </div>
                                                    <a href="" class="nav-link " style="color: #7ae582;">
                                                        View All
                                                        <i class="bi bi-arrow-right-circle"></i>
                                                    </a>
                                                </div>
                                                <a class="btn btn-app"
                                                    style="background-color: #7ae582; border-radius: 10px;">
                                                    <i class="bi bi-card-checklist bi-main"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- search and filter bar -->
            <div class="container-fluid hidden-transition">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active shadow" aria-current="page" href="#"
                            style="background-color: transparent;">Survey Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'survey_managment:compareData' %}">Compare Data</a>
                    </li>
                </ul>
                <br>


                <div class="container-fluid" style="background-color: #e3f2fd;">
                    <div class="container-fluid" id="searchArea">
                        <h2 class="textS">Search Area</h2>
                        <div class="row ">
                            <!-- <div class="form-group col-lg-4 col-sm-6">
                                <label class="textS">Line Ministry</label>
                                <select id="survey-select" class="form-control">
                                    <option selected="selected">Select Line Ministry</option>
                                    {% for minister in line_ministry %}
                                      <option value="{{ minister.name }}">{{ minister.name }}</option>
                                    {% endfor %}
                                  </select>
                            </div> -->
                            <!-- <div class="form-group col-lg-4 col-sm-6">
                                <label class="textS">Survey</label>
                                <select id="survey-select" class="form-control">
                                    <option selected="selected">Select Category</option>
                                    {% for survey in survey %}
                                      <option value="{{ survey.name }}">{{ survey.name }}</option>
                                    {% endfor %}
                                  </select>
                            </div > -->
                            <form method="POST" id="form">
                                <div class="row">
                                    {% csrf_token %}
                                    <div class="form-group col-lg-3 col-sm-6">
                                        <label class="textS" for="{{ form.survey_type.id_for_label }}">Survey
                                            Type:</label>
                                        {{ form.survey_type }}
                                    </div>
                                    <div class="form-group col-lg-3 col-sm-6">
                                        <label class="textS">Survey:</label>
                                        {{ form.survey }}
                                    </div>
                                    <div class="form-group col-lg-3 col-sm-6">
                                        <label class="textS">Line Ministry:</label>
                                        {{ form.line_ministry }}
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                            <!-- <div class="form-group col-lg-4 col-sm-6">
                                <label class="textS">Catagory</label>
                                <select class="form-control ">
                                    <option selected="selected">Alabama</option>
                                    <option>Alaska</option>
                                   
                                </select>
                            </div> -->
                            {%include "includes/select.html"%}
                            <div class="container mt-5 mb-5 row ">
                                <div class="form-group col-lg-4 col-sm-6">
                                        <select id="survey-select" class="form-control">
                                        <option selected="selected" >Select survey</option>
                                        
                                      </select>
                                </div>
                                <div class="form-group col-lg-4 col-sm-6">
                                    <select id="ministry-select" class="form-control">
                                    <option selected="selected">Select survey</option>
                                    
                                  </select>
                                  
                            </div>
                                <table class="table table-striped" id="surveyTable">
                                    <thead>
                                        <th>Survey Name </th>
                                        <th>Suvey instruction </th>
                                        <th>start date </th>
                                        <th>end date </th>
                                        <th> created_at </th>


                                    </thead>
                                    <tbody id="tbody">

                                    </tbody>
                                </table>
                                <table class="table table-striped" id="survey_detail">
                                    <thead>
                                        <th> ጥያቄ</th>
                                        <th> ደረጃ </th>
                                        <th> ክብደት </th>

                                        <th>የተመዘነ ደረጃ </th>
                                        <th> የተመዘነ ደረጃ (በ100% ኛ) </th>
                                        <th> Indicator </th>
                                        <th> Grading </th>


                                       


                                    </thead>
                                    <tbody id="tbody">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <br>
            </div>



            <!-- table -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card hidden-transition">

                                <div class="card-header" style="justify-content: space-between;">
                                    <div class="card-title">
                                        <div id="selected-survey"></div>
                                    </div>
                                    <div class="d-flex" style="float: right;">
                                        <div class="me-3">
                                            <input class="form-control form-control-sm" type="text"
                                                placeholder="Search Here" aria-label=".form-control-sm example">
                                        </div>
                                        <div class="dropdown">
                                            <a href="" class="btn btn-primary btn-sm btn-wave waves-effect waves-light"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                                Sort By<i
                                                    class="ri-arrow-down-s-line align-middle ms-1 d-inline-block"></i>
                                            </a>
                                            <ul class="dropdown-menu" role="menu">
                                                <li><a class="dropdown-item" href="">New</a></li>
                                                <li><a class="dropdown-item" href="">Popular</a></li>
                                                <li><a class="dropdown-item" href="">Relevant</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>


                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table text-nowrap table-hover border table-bordered">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Line Minister</th>
                                                    <th scope="col">Question 1</th>
                                                    <th scope="col">Question 2</th>
                                                    <th scope="col">Question 3</th>
                                                    <th scope="col">Question 4</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Manufacture</td>
                                                    <td>Team Lead</td>
                                                    <td>mayorkelly@gmail.com</td>
                                                    <td>
                                                        <div class="d-inline-flex align-items-center">
                                                            <i class="ri-map-pin-fill text-muted fs-10"></i>
                                                            <span class="ms-1">Germany</span>
                                                        </div>
                                                    </td>
                                                    <td>Sep 15 - Oct 12, 2023</td>
                                                </tr>
                                                <tr>
                                                    <td>Manufacture</td>
                                                    <td>Team Lead</td>
                                                    <td>mayorkelly@gmail.com</td>
                                                    <td>
                                                        <div class="d-inline-flex align-items-center">
                                                            <i class="ri-map-pin-fill text-muted fs-10"></i>
                                                            <span class="ms-1">Germany</span>
                                                        </div>
                                                    </td>
                                                    <td>Sep 15 - Oct 12, 2023</td>
                                                </tr>
                                                <tr>
                                                    <td>Manufacture</td>
                                                    <td>Team Lead</td>
                                                    <td>mayorkelly@gmail.com</td>
                                                    <td>
                                                        <div class="d-inline-flex align-items-center">
                                                            <i class="ri-map-pin-fill text-muted fs-10"></i>
                                                            <span class="ms-1">Germany</span>
                                                        </div>
                                                    </td>
                                                    <td>Sep 15 - Oct 12, 2023</td>
                                                </tr>
                                                <tr>
                                                    <td>Manufacture</td>
                                                    <td>Team Lead</td>
                                                    <td>mayorkelly@gmail.com</td>
                                                    <td>
                                                        <div class="d-inline-flex align-items-center">
                                                            <i class="ri-map-pin-fill text-muted fs-10"></i>
                                                            <span class="ms-1">Germany</span>
                                                        </div>
                                                    </td>
                                                    <td>Sep 15 - Oct 12, 2023</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex align-items-center">
                                        <div>
                                            Showing 6 Entries <i class="bi bi-arrow-right ms-2 fw-semibold"></i>
                                        </div>
                                        <div class="ms-auto">
                                            <nav aria-label="Page navigation" class="pagination-style-4">
                                                <ul class="pagination mb-0">
                                                    <li class="page-item disabled">
                                                        <a class="page-link" href="javascript:void(0);">
                                                            Prev
                                                        </a>
                                                    </li>
                                                    <li class="page-item active"><a class="page-link"
                                                            href="javascript:void(0);">1</a></li>
                                                    <li class="page-item"><a class="page-link"
                                                            href="javascript:void(0);">2</a></li>
                                                    <li class="page-item">
                                                        <a class="page-link text-primary" href="javascript:void(0);">
                                                            next
                                                        </a>
                                                    </li>
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- two graphs  -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-6 col-md-6">
                            <div class="card shadow hidden-transition">
                                <div class="card-body">
                                    <div class="flex-fill">
                                        <div class="form-group">
                                            <select class="form-control " style="width: 100%;">
                                                <option selected="selected">choose chart</option>
                                                <option>Alaska</option>
                                                <option>California</option>
                                                <option>Delaware</option>
                                                <option>Tennessee</option>
                                                <option>Texas</option>
                                                <option>Washington</option>
                                            </select>
                                        </div>
                                        <figure class="highcharts-figure mb-0">
                                            <div id="pieChart"></div>
                                        </figure>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6">
                            <div class="card shadow hidden-transition">
                                <div class="card-body">
                                    <figure class="highcharts-figure mb-0">
                                        <div id="barChart"></div>
                                        <p class="highcharts-description"></p>
                                    </figure>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


        </div>
    </div>



    {% include "includes/scripts.html" %}
    <script>
        fetch('http://127.0.0.1:8000/get_json/')
            .then(res => res.json())
            .then(data => {
                var surveyTypeInput = document.getElementById('survey_type');
                var surveyTableBody_1 = document.getElementById('surveyTable').getElementsByTagName('tbody')[0];
                var surveyTableBody_2 = document.getElementById('survey_detail').getElementsByTagName('tbody')[0];
                var select_ministry = document.getElementById("ministry-select");
                var selectElement = document.getElementById("survey-select");



                // Populate the survey type options
                data.survey_type.forEach(surveyType => {
                    var option = document.createElement('option');
                    option.value = surveyType.id;
                    option.textContent = surveyType.name;
                    surveyTypeInput.appendChild(option);


                });


                surveyTypeInput.addEventListener('change', function () {
                    var selectedSurveyTypeId = parseInt(surveyTypeInput.value);
                    console.log('Selected survey:', selectedSurveyTypeId); 

                    clearTable(surveyTableBody_1);
                    clearOptions(select_ministry)
                  

                    if (selectedSurveyTypeId) {
                        var surveys = data.survey.filter(survey => survey.survey_type_id === selectedSurveyTypeId);
                      
                        surveys.forEach(survey => {
                            var row = surveyTableBody_1.insertRow();
                            row.insertCell().textContent = survey.name;
                            row.insertCell().textContent = survey.instruction;
                            row.insertCell().textContent = survey.start_at;
                            row.insertCell().textContent = survey.end_at;
                            row.insertCell().textContent = survey.created_at;

                            var option = document.createElement("option");
                            option.value = survey.id; 
                            option.textContent = survey.name;
                            selectElement.appendChild(option); 
 
                           selectElement.addEventListener('change', function() {
      var selectedSurvey = selectElement.value;
      console.log('Selected survey:', selectedSurvey); 
  
  var selectedSurveyId = parseInt(selectElement.value);
  for (var i = 0; i < data.surveys.length; i++) {
  if (data.surveys[i].id === selectedSurveyId) {
    selectedSurvey = data.surveys[i];
    break;
  }
}

if (selectedSurvey) {
  var lineMinistries = selectedSurvey.line_ministries;
while(select_ministry.firstChild){
    select_ministry.removeChild(select_ministry.firstChild)
}

lineMinistries.forEach(function(lineMinistry){
    var ministry_option = document.createElement("option");
    ministry_option.value = lineMinistry.id;
    ministry_option.textContent = lineMinistry.name;
    select_ministry.append(ministry_option)

});

  console.log('Line ministries:', lineMinistries);
} else {
  console.log('Selected survey not found');
}});


select_ministry.addEventListener("change", function() {
  var selectedLineMinistry = parseInt(select_ministry.value);
  
  userResponseId = null;
data.user_response.forEach(function(userResponse) {
    if (userResponse.submitted_by_id === selectedLineMinistry) {
        userResponseId = userResponse.id;
        return;  // Exit the loop once a match is found
    }
});

if (userResponseId !== null)
 {
    var answers = data.answer.filter(function(answer) {
        return answer.response_id === userResponseId;
    });

    console.log(answers);
    var answerValues = answers.map(function(answer){
        return {
            value: parseFloat(answer.answertext),
            questionId: answer.forquestion_id
        };
    });

var weightedSum = 0;
var totalWeight = 0;

   
answerValues.forEach(function(answer) {
        var question = data.questions.find(function(q) {
            return q.id === answer.questionId;
        });


        if (question) {
            var weight = question.weight;
            console.log("the question :" + question.title + "the weight:" + weight)
            


            if (!isNaN(answer.value)) {
                weightedSum += answer.value * weight;

                totalWeight += weight;
            }

            if (totalWeight > 0) {
        var weightedAverage = weightedSum / totalWeight;
        var row = surveyTableBody_2.insertRow();
            row.insertCell().textContent = question.title;
            row.insertCell().textContent = answer.value;
            row.insertCell().textContent = weight;
            row.insertCell().textContent = answer.value * weight ;
            var totalresult = answer.value * weight
            var max_value = 10 ;
            var weightedinPercent = ( (totalresult) / (max_value* weight) )* 100  + "%";
            row.insertCell().textContent = weightedinPercent;

           
            var x = answer.value * weight;

if (x > 90) {
    row.insertCell().textContent =" Very Good" ;

} else if (x > 79) {
  row.insertCell().textContent = "Good" ;

} else if (x > 64) {
  row.insertCell().textContent = "Satisfactory" ;

} else if (x > 49) {
  row.insertCell().textContent = "Poor" ;

} else if (x > 24) {
  row.insertCell().textContent = "Very Poor" ;

} else {
  row.insertCell().textContent = "Extremely Poor" ;

}

        console.log("Weighted average of answers: " + weightedAverage.toFixed(2));
    } else {
        console.log("No valid answers found for the selected line ministry.");
    } 
            


           
        }
    });

   
}
 else {
    console.log("No user_response ID found for the selected line ministry.");
}





  console.log("Selected line ministry: " + selectedLineMinistry);
});
                            var selectedSurvey = (selectElement.value);
                         });
                                                }
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });

        function clearTable(tableBody) {
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
        }
        function clearOptions(select) {
    while (select.firstChild) {
        select.removeChild(select.firstChild);
    }
}

  
    </script>

</body>

</html>


